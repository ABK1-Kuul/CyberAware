// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  role      UserRole @default(learner)
  team      String
  departmentId String? @map("department_id")
  createdAt DateTime @default(now()) @map("created_at")
  avatarUrl String   @map("avatar_url")
  ssoId     String?  @unique @map("sso_id")
  magicToken String? @unique @map("magic_token")
  magicTokenPinnedIp String? @map("magic_token_pinned_ip")
  magicTokenPinnedUserAgent String? @map("magic_token_pinned_user_agent")
  magicTokenPinnedAt DateTime? @map("magic_token_pinned_at")

  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  riskProfile UserRiskProfile?
  phishingEvents PhishingEvent[]
  reportedItems ReportedItem[]
  enrollments Enrollment[]
  auditLogs   AuditLog[]
  activityLogs ActivityLog[]
  userNotifications UserNotification[]
  courseSessions CourseSession[]
  riskProfile UserRiskProfile?

  @@map("users")
  @@index([email])
  @@index([role])
  @@index([departmentId])
  @@index([ssoId])
  @@index([magicToken])
}

model Department {
  id         String   @id @default(uuid())
  name       String   @unique
  riskScore  Int      @default(50) @map("risk_score")
  totalUsers Int      @map("total_users")
  lastSynced DateTime @default(now()) @map("last_synced")
  users      User[]

  @@map("departments")
  @@index([riskScore])
  @@index([lastSynced])
}

model UserRiskProfile {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  riskScore        Int      @default(50) @map("risk_score")
  reportingStreak  Int      @default(0) @map("reporting_streak")
  totalReported    Int      @default(0) @map("total_reported")
  achievements     Json?    @db.Json @map("achievements")
  lastReportedAt   DateTime? @map("last_reported_at")
  lastUpdated      DateTime @default(now()) @map("last_updated")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_risk_profiles")
  @@index([riskScore])
  @@index([reportingStreak])
  @@index([lastReportedAt])
  @@index([lastUpdated])
}

model PhishingCampaign {
  id           String          @id @default(uuid()) // This maps to Gophish Campaign ID
  name         String
  status       String
  targetGroups String          @map("target_groups")
  results      PhishingEvent[]
  createdAt    DateTime        @default(now()) @map("created_at")

  @@map("phishing_campaigns")
  @@index([status])
  @@index([createdAt])
}

model PhishingEvent {
  id         String           @id @default(uuid())
  campaignId String           @map("campaign_id")
  campaign   PhishingCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId     String           @map("user_id")
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventType  String           @map("event_type")
  occurredAt DateTime         @default(now()) @map("occurred_at")
  details    Json?            @db.Json

  @@map("phishing_events")
  @@index([campaignId])
  @@index([userId])
  @@index([eventType])
  @@index([occurredAt])
}

model Course {
  id             String   @id @default(cuid())
  title          String
  description    String   @db.Text
  version        String
  scormPath      String   @map("scorm_path")
  createdAt      DateTime @default(now()) @map("created_at")
  enrollmentCount Int     @default(0) @map("enrollment_count")

  enrollments Enrollment[]
  courseSessions CourseSession[]

  @@map("courses")
  @@index([createdAt])
}


model Enrollment {
  id          String            @id @default(cuid())
  userId      String            @map("user_id")
  courseId    String            @map("course_id")
  status      EnrollmentStatus  @default(NotStarted)
  progress    Int               @default(0)
  assignedAt  DateTime          @default(now()) @map("assigned_at")
  completedAt DateTime?         @map("completed_at")

  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  scormData   ScormData?
  certificate Certificate?
  courseSessions CourseSession[]

  @@map("enrollments")
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([assignedAt])
  @@index([completedAt])
  @@index([userId, status])
  @@index([courseId, status])
  @@unique([userId, courseId])
}

model CourseSession {
  id            String   @id @default(cuid())
  enrollmentId  String   @map("enrollment_id")
  userId        String   @map("user_id")
  courseId      String   @map("course_id")
  contentType   CourseContentType @map("content_type")
  suspendData   String?  @db.Text @map("suspend_data")
  h5pState      Json?    @db.Json @map("h5p_state")
  lessonLocation String? @map("lesson_location")
  status        CourseSessionStatus @default(NotStarted)
  score         Float?   @map("score")
  certificateSent Boolean @default(false) @map("certificate_sent")
  pinnedIp      String?  @map("pinned_ip")
  pinnedUserAgent String? @map("pinned_user_agent")
  pinnedAt      DateTime? @map("pinned_at")
  startedAt     DateTime? @map("started_at")
  lastActivityAt DateTime? @map("last_activity_at")
  completedAt   DateTime? @map("completed_at")

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("course_sessions")
  @@index([enrollmentId])
  @@index([userId])
  @@index([courseId])
  @@index([contentType])
  @@index([status])
  @@index([lastActivityAt])
  @@index([certificateSent])
  @@unique([enrollmentId, contentType])
}

model ScormData {
  id           String   @id @default(cuid())
  enrollmentId String   @unique @map("enrollment_id")
  cmiData      Json     @map("cmi_data") @db.Json
  lastLocation String   @default("") @map("last_location")
  completionStatus String? @map("completion_status")
  successStatus String? @map("success_status")
  scoreRaw     Float?   @map("score_raw")
  scoreMin     Float?   @map("score_min")
  scoreMax     Float?   @map("score_max")
  totalTimeSeconds Int? @map("total_time_seconds")
  sessionTimeSeconds Int? @map("session_time_seconds")
  lastCommitAt DateTime? @map("last_commit_at")

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@map("scorm_data")
}

model Certificate {
  id           String    @id @default(cuid())
  enrollmentId String    @unique @map("enrollment_id")
  path         String
  issuedAt     DateTime  @default(now()) @map("issued_at")
  uuid         String    @unique

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@map("certificates")
  @@index([uuid])
  @@index([issuedAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String?  @map("actor_id")
  action    String
  details   Json     @db.Json
  complianceStatus String? @map("compliance_status")
  createdAt DateTime @default(now()) @map("created_at")

  actor User? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
  @@index([actorId])
  @@index([createdAt])
  @@index([action])
  @@index([complianceStatus])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  action    String
  metadata  Json?    @db.Json
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("activity_logs")
  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

model ReportedItem {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            ReportType
  targetUrl       String   @map("target_url")
  emailSubject    String?  @map("email_subject")
  headers         Json?    @db.Json
  senderIp        String?  @map("sender_ip")
  returnPath      String?  @map("return_path")
  messageId       String?  @map("message_id")
  emailBody       String?  @db.LongText @map("email_body")
  status          IncidentStatus @default(PENDING)
  gophishCampaignId String? @map("gophish_campaign_id")
  incidentGroupId String?  @map("incident_group_id")
  incidentGroup   IncidentGroup? @relation(fields: [incidentGroupId], references: [id], onDelete: SetNull)
  riskScoreAtReport Int    @map("risk_score_at_report")
  wasRealThreat   Boolean? @map("was_real_threat")
  remediationTaken String? @map("remediation_taken")
  screenshotUrl   String?  @map("screenshot_url")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("reported_items")
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([gophishCampaignId])
  @@index([incidentGroupId])
  @@index([messageId])
  @@index([createdAt])
}

model IncidentGroup {
  id              String   @id @default(uuid())
  normalizedUrl   String   @unique @map("normalized_url")
  domain          String   @map("domain")
  firstReportedAt DateTime @default(now()) @map("first_reported_at")
  lastReportedAt  DateTime @default(now()) @map("last_reported_at")
  reportCount     Int      @default(1) @map("report_count")
  severity        IncidentSeverity @default(LOW)
  vtDetections    Int?     @map("vt_detections")
  reports         ReportedItem[]
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("incident_groups")
  @@index([domain])
  @@index([severity])
  @@index([lastReportedAt])
}

model GlobalNotification {
  id        String   @id @default(uuid())
  title     String
  message   String
  severity  String
  reportId  String?  @map("report_id")
  domain    String?
  active    Boolean  @default(true)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("global_notifications")
  @@index([severity])
  @@index([active])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([domain])
}

model UserNotification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("user_notifications")
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model BlockedDomain {
  id          String   @id @default(uuid())
  domain      String   @unique
  source      String?  @map("source")
  reportId    String?  @map("report_id")
  incidentGroupId String? @map("incident_group_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("blocked_domains")
  @@index([createdAt])
  @@index([updatedAt])
}

enum ReportType {
  SIMULATION
  EXTERNAL
}

enum IncidentStatus {
  PENDING
  VERIFIED_THREAT
  FALSE_POSITIVE
  ARCHIVED
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum UserRole {
  admin
  learner
}

enum EnrollmentStatus {
  NotStarted
  InProgress
  Completed
}

enum CourseContentType {
  SCORM
  H5P
}

enum CourseSessionStatus {
  NotStarted
  InProgress
  Completed
  Passed
  Failed
}
