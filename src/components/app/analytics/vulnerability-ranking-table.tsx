import { format } from "date-fns"
import { ArrowDownRight, ArrowRight, ArrowUpRight } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import type { TopRiskDepartment } from "@/services/analytics"

function TrendIcon({ trend }: { trend: TopRiskDepartment["trend"] }) {
  if (trend === "up") return <ArrowUpRight className="h-4 w-4 text-emerald-300" />
  if (trend === "down") return <ArrowDownRight className="h-4 w-4 text-red-300" />
  return <ArrowRight className="h-4 w-4 text-amber-300" />
}

function formatFailureDate(value: Date | null) {
  if (!value) return "No recent failures"
  return format(value, "MMM dd, yyyy")
}

export function VulnerabilityRankingTable({ departments }: { departments: TopRiskDepartment[] }) {
  return (
    <Card className="bg-slate-950/40 border-slate-800 shadow-lg">
      <CardHeader>
        <CardTitle className="font-headline">Top 5 At-Risk Departments</CardTitle>
      </CardHeader>
      <CardContent>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Department</TableHead>
              <TableHead>Resilience</TableHead>
              <TableHead>Last Failure</TableHead>
              <TableHead className="text-right">Action</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {departments.length === 0 ? (
              <TableRow>
                <TableCell colSpan={4} className="text-muted-foreground">
                  No departmental risk data available yet.
                </TableCell>
              </TableRow>
            ) : (
              departments.map((dept) => (
                <TableRow key={dept.name}>
                  <TableCell className="font-medium">{dept.name}</TableCell>
                  <TableCell>
                    <div className="flex items-center gap-2">
                      <TrendIcon trend={dept.trend} />
                      <span className="font-mono">{dept.resilienceScore}</span>
                    </div>
                  </TableCell>
                  <TableCell className="text-muted-foreground">
                    {formatFailureDate(dept.lastFailureAt)}
                  </TableCell>
                  <TableCell className="text-right">
                    <Button variant="outline" size="sm">
                      Trigger Drill
                    </Button>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  )
}
